Pod affinity
Thay vÃ¬ deploy pod tá»›i nhá»¯ng node, thÃ¬ ta sáº½ cÃ³ má»™t nhu cáº§u khÃ¡c ná»¯a lÃ  deploy pod gáº§n vá»›i má»™t pod khÃ¡c. VÃ­ dá»¥ dÆ° lÃ  ta cÃ³ pod backend vÃ  pod database, ta sáº½ muá»‘n hai pod Ä‘Ã³ Ä‘Æ°á»£c deploy gáº§n vá»›i nhau Ä‘á»ƒ Ä‘á»™ trá»… cá»§a API lÃ  tháº¥p nháº¥t.

Ta cÃ³ thá»ƒ lÃ m viá»‡c Ä‘Ã³ báº±ng cÃ¡ch báº±ng node affinity, nhÆ°ng ta sáº½ cáº§n Ä‘Ã¡nh label cho node vÃ  chá»‰ Ä‘á»‹nh rÃµ nhá»¯ng node cÃ³ thá»ƒ deploy cho pod, Ä‘Ã¢y khÃ´ng pháº£i lÃ  cÃ¡ch tá»‘t cho váº¥n Ä‘á» nÃ y. Ta sá»­ dá»¥ng node affinity Ä‘á»ƒ deploy pod tá»›i má»™t cá»¥m node cá»¥ thá»ƒ, sau Ä‘Ã³ ta sáº½ Ä‘á»ƒ nhá»¯ng pod liÃªn quan Ä‘Æ°á»£c deploy gáº§n vá»›i nhau.

VÃ­ dá»¥ ta táº¡o má»™t pod database nhÆ° sau:

$ kubectl run database -l app=database --image busybox -- sleep 999999

Sau Ä‘Ã³, ta sáº½ táº¡o pod backend vÃ  chá»‰ Ä‘á»‹nh pod affinity Ä‘á»ƒ nÃ³ Ä‘Æ°á»£c deploy gáº§n vá»›i pod database.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: kubernetes.io/hostname
              labelSelector:
                  matchLabels:
                    app: database
      containers:
        - name: main
          image: alpine
          command: ["/bin/sleep", "999999"]

Äá»ƒ xÃ i chá»©c nÄƒng Pod Affinity thÃ¬ ta dÃ¹ng trÆ°á»ng podAffinity á»Ÿ trÆ°á»ng affinity. GiÃ¡ trá»‹ requiredDuringSchedulingIgnoredDuringExecution thÃ¬ cÅ©ng cÃ³ Ã½ nghÄ©a giá»‘ng vá»›i nodeAffinity, ta sáº½ chá»‰ Ä‘á»‹nh scope cá»§a pod báº±ng trÆ°á»ng topologyKey, á»Ÿ file trÃªn thÃ¬ scope ta chá»‰ Ä‘á»‹nh lÃ  chá»‰ trong má»™t node vá»›i thuá»™c tÃ­nh kubernetes.io/hostname.

Khi pod mÃ  ta chá»‰ Ä‘á»‹nh podAffinity Ä‘Æ°á»£c deploy, nÃ³ sáº½ kiáº¿m nhá»¯ng pod nÃ o mÃ  cÃ³ label trong trÆ°á»ng matchLabels, sau Ä‘Ã³ sáº½ deploy pod tá»›i pod Ä‘Ã£ Ä‘Æ°á»£c chá»n cÃ¹ng trong má»™t node. Ta cÃ³ thá»ƒ tÄƒng scope nÃ y lÃªn báº±ng trÆ°á»ng topologyKey.

image.png

topologyKey
ÄÃ¢y lÃ  thuá»™c tÃ­nh giÃºp ta chá»‰ scope cá»§a pod khi nÃ³ Ä‘Æ°Æ¡c deploy gáº§n vá»›i má»™t pod khÃ¡c, thÆ°á»ng Ä‘Æ°á»£c quan tÃ¢m khi ta dÃ¹ng cloud, náº¿u báº¡n khÃ´ng xÃ i cloud thÃ¬ cÃ³ thá»ƒ bá» qua khÃ´ng cáº§n tÃ¬m hiá»ƒu thuá»™c tÃ­nh nÃ y. Náº¿u báº¡n cÃ³ xÃ i cloud, thÃ¬ ta sáº½ quen thuá»™c vá»›i cÃ¡c tá»« nhÆ° lÃ  availability zone hoáº·c region, ta cÃ³ thá»ƒ dÃ¹ng topologyKey Ä‘á»ƒ Ä‘á»‹nh nghÄ©a pod sáº½ Ä‘Æ°á»£c deploy tá»›i gáº§n má»™t pod khÃ¡c trong cÃ¹ng má»™t node, cÃ¹ng má»™t AZ hoáº·c cÅ©ng má»™t region.

Ta lÃ m viá»‡c nÃ y báº±ng cÃ¡ch Ä‘Ã¡nh label cho node vá»›i key lÃ  kubernetes.io/zone hoáº·c kubernetes.io/region, sau Ä‘Ã³ ta chá»‰ Ä‘á»‹nh trÆ°á»ng topologyKey nhÆ° sau:

...
- topologyKey: kubernetes.io/zone
...

Ta Ä‘Ã£ tháº¥y cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a pod affinity, sáº½ giÃºp ta deploy nhá»¯ng pod gáº§n vá»›i nhau nhÆ° ta muá»‘n. Kubernetes cÅ©ng cÃ³ cung cáº¥p cho ta cÃ¡ch Ä‘á»ƒ deploy má»™t pod mÃ  cÃ¡ch xa so vá»›i pod cÃ²n láº¡i náº¿u báº¡n muá»‘n, dÃ¹ng pod anti-affinity.

Pod anti-affinity
ThÃ¬ thay vÃ¬ muá»‘n deploy pod gáº§n vá»›i nhau thÃ¬ ta sáº½ muá»‘n deploy nhá»¯ng pod cÃ¡ch xa nhau ra. Thá»±c táº¿ thÃ¬ mÃ¬nh cÅ©ng chÆ°a cÃ³ tÃ¬m ra Ä‘Æ°á»£c lá»£i Ã­ch cá»§a viá»‡c sá»­ dá»¥ng tháº±ng nÃ y ğŸ˜‚. Äá»ƒ sá»­ dá»¥ng chá»©c nÄƒng nÃ y thÃ¬ thay vÃ¬ dÃ¹ng trÆ°á»ng podAffinity thÃ¬ ta sáº½ dÃ¹ng trÆ°á»ng podAntiAffinity. VÃ­ dá»¥ nhÆ° sau:

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: kubernetes.io/hostname
              labelSelector:
                  matchLabels:
                    app: backend
      containers:
        - name: main
          image: alpine
          command: ["/bin/sleep", "999999"]

á» file trÃªn ta sáº½ chá»‰ Ä‘á»‹nh pod front-end sáº½ Ä‘Æ°á»£c deploy cÃ¡ch xa khá»i pod backend vá»›i scope lÃ  trong má»™t node, cÃ³ nghÄ©a lÃ  náº¿u má»™t node cÃ³ chá»©a pod backend thÃ¬ pod front-end sáº½ khÃ´ng Ä‘Æ°á»£c deploy tá»›i node Ä‘Ã³.

https://viblo.asia/p/k8s-basic-advanced-scheduling-lap-lich-tren-kubernetes-dung-affinity-5OXLAo8M4Gr

Tham https://viblo.asia/p/k8s-basic-advanced-scheduling-lap-lich-tren-kubernetes-dung-affinity-5OXLAo8M4Gr